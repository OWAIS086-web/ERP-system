{% extends "layout.html" %}

{% block page_title %}Attendance Management{% endblock %}
{% block page_subtitle %}Track and manage employee attendance{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>Attendance Management</h2>
            <p class="text-muted">Monitor employee attendance, clock-ins, and work hours</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <a href="{{ url_for('hr.add_attendance') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Record Attendance
                </a>
                <button type="button" class="btn btn-outline-secondary" onclick="exportAttendance()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ stats.present_today or 0 }}</h3>
                    <p class="text-muted mb-0">Present Today</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger">{{ stats.absent_today or 0 }}</h3>
                    <p class="text-muted mb-0">Absent Today</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ stats.late_today or 0 }}</h3>
                    <p class="text-muted mb-0">Late Today</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ stats.on_leave_today or 0 }}</h3>
                    <p class="text-muted mb-0">On Leave</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" name="date" 
                                   value="{{ request.args.get('date', today.strftime('%Y-%m-%d')) }}">
                        </div>
                        <div class="col-md-3">
                            <label for="department" class="form-label">Department</label>
                            <select class="form-select" id="department" name="department">
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.id }}" 
                                            {% if request.args.get('department') == dept.id|string %}selected{% endif %}>
                                        {{ dept.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Status</option>
                                <option value="present" {% if request.args.get('status') == 'present' %}selected{% endif %}>Present</option>
                                <option value="absent" {% if request.args.get('status') == 'absent' %}selected{% endif %}>Absent</option>
                                <option value="late" {% if request.args.get('status') == 'late' %}selected{% endif %}>Late</option>
                                <option value="half_day" {% if request.args.get('status') == 'half_day' %}selected{% endif %}>Half Day</option>
                                <option value="holiday" {% if request.args.get('status') == 'holiday' %}selected{% endif %}>Holiday</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="employee" class="form-label">Employee</label>
                            <select class="form-select" id="employee" name="employee">
                                <option value="">All Employees</option>
                                {% for emp in employees %}
                                    <option value="{{ emp.id }}" 
                                            {% if request.args.get('employee') == emp.id|string %}selected{% endif %}>
                                        {{ emp.full_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Records -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Attendance Records</h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="markAllPresent()">
                            <i class="fas fa-check"></i> Mark All Present
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="bulkUpdate()">
                            <i class="fas fa-edit"></i> Bulk Update
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if attendance_records %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                        </th>
                                        <th>Employee</th>
                                        <th>Date</th>
                                        <th>Clock In</th>
                                        <th>Clock Out</th>
                                        <th>Hours Worked</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in attendance_records %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" class="record-checkbox" value="{{ record.id }}">
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                        {{ record.employee.first_name[0] }}{{ record.employee.last_name[0] }}
                                                    </div>
                                                    <div>
                                                        <a href="{{ url_for('hr.employee_detail', id=record.employee.id) }}">
                                                            {{ record.employee.full_name }}
                                                        </a>
                                                        <br><small class="text-muted">{{ record.employee.employee_id }}</small>
                                                        {% if record.employee.department %}
                                                            <br><small class="text-muted">{{ record.employee.department.name }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ record.date.strftime('%b %d, %Y') }}</td>
                                            <td>
                                                {% if record.clock_in %}
                                                    {{ record.clock_in.strftime('%I:%M %p') }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.clock_out %}
                                                    {{ record.clock_out.strftime('%I:%M %p') }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if record.hours_worked %}
                                                    <span class="badge bg-info">{{ record.hours_worked }}h</span>
                                                    {% if record.overtime_hours > 0 %}
                                                        <br><small class="text-warning">+{{ record.overtime_hours }}h OT</small>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge 
                                                    {% if record.status == 'present' %}bg-success
                                                    {% elif record.status == 'absent' %}bg-danger
                                                    {% elif record.status == 'late' %}bg-warning
                                                    {% elif record.status == 'half_day' %}bg-info
                                                    {% elif record.status == 'holiday' %}bg-secondary
                                                    {% else %}bg-light text-dark{% endif %}">
                                                    {{ record.status|replace('_', ' ')|title }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                                            onclick="editAttendance({{ record.id }})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    {% if not record.clock_out and record.status == 'present' %}
                                                        <button type="button" class="btn btn-outline-success btn-sm" 
                                                                onclick="clockOut({{ record.id }})">
                                                            <i class="fas fa-sign-out-alt"></i>
                                                        </button>
                                                    {% endif %}
                                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                                            onclick="deleteAttendance({{ record.id }})">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No attendance records found</h5>
                            <p class="text-muted">No attendance records match your current filters.</p>
                            <a href="{{ url_for('hr.add_attendance') }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Record Attendance
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Attendance Modal -->
<div class="modal fade" id="editAttendanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editAttendanceForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_clock_in" class="form-label">Clock In Time</label>
                        <input type="time" class="form-control" id="edit_clock_in" name="clock_in">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_clock_out" class="form-label">Clock Out Time</label>
                        <input type="time" class="form-control" id="edit_clock_out" name="clock_out">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_break_start" class="form-label">Break Start</label>
                        <input type="time" class="form-control" id="edit_break_start" name="break_start">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_break_end" class="form-label">Break End</label>
                        <input type="time" class="form-control" id="edit_break_end" name="break_end">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_status" class="form-label">Status</label>
                        <select class="form-select" id="edit_status" name="status">
                            <option value="present">Present</option>
                            <option value="absent">Absent</option>
                            <option value="late">Late</option>
                            <option value="half_day">Half Day</option>
                            <option value="holiday">Holiday</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="edit_notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Attendance</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Clock Out Modal -->
<div class="modal fade" id="clockOutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Clock Out</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="clockOutForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="clock_out_time" class="form-label">Clock Out Time</label>
                        <input type="time" class="form-control" id="clock_out_time" name="clock_out_time" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="clock_out_notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="clock_out_notes" name="notes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Clock Out</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentRecordId = null;

function editAttendance(recordId) {
    currentRecordId = recordId;
    
    // Fetch attendance record data
    fetch(`/hr/attendance/${recordId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('edit_clock_in').value = data.clock_in || '';
            document.getElementById('edit_clock_out').value = data.clock_out || '';
            document.getElementById('edit_break_start').value = data.break_start || '';
            document.getElementById('edit_break_end').value = data.break_end || '';
            document.getElementById('edit_status').value = data.status || 'present';
            document.getElementById('edit_notes').value = data.notes || '';
            
            new bootstrap.Modal(document.getElementById('editAttendanceModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading attendance data');
        });
}

function clockOut(recordId) {
    currentRecordId = recordId;
    
    // Set current time as default
    const now = new Date();
    const timeString = now.toTimeString().slice(0, 5);
    document.getElementById('clock_out_time').value = timeString;
    
    new bootstrap.Modal(document.getElementById('clockOutModal')).show();
}

function deleteAttendance(recordId) {
    if (confirm('Are you sure you want to delete this attendance record?')) {
        fetch(`/hr/attendance/${recordId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting attendance record: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting attendance record');
        });
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.record-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function markAllPresent() {
    const selectedIds = Array.from(document.querySelectorAll('.record-checkbox:checked'))
                            .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Please select attendance records to update');
        return;
    }
    
    if (confirm(`Mark ${selectedIds.length} selected records as present?`)) {
        fetch('/hr/attendance/bulk-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                record_ids: selectedIds,
                status: 'present'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating attendance records: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating attendance records');
        });
    }
}

function bulkUpdate() {
    const selectedIds = Array.from(document.querySelectorAll('.record-checkbox:checked'))
                            .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Please select attendance records to update');
        return;
    }
    
    // Implementation for bulk update modal
    alert('Bulk update functionality will be implemented');
}

function exportAttendance() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'excel');
    window.open(`{{ url_for('hr.attendance') }}?${params.toString()}`, '_blank');
}

// Handle form submissions
document.getElementById('editAttendanceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const attendanceData = Object.fromEntries(formData);
    
    fetch(`/hr/attendance/${currentRecordId}/edit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(attendanceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error updating attendance: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating attendance');
    });
});

document.getElementById('clockOutForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const clockOutData = Object.fromEntries(formData);
    
    fetch(`/hr/attendance/${currentRecordId}/clock-out`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(clockOutData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error clocking out: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error clocking out');
    });
});

// Auto-submit form on filter change
document.querySelectorAll('#department, #status, #employee').forEach(select => {
    select.addEventListener('change', function() {
        this.form.submit();
    });
});
</script>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 12px;
    font-weight: bold;
}
</style>
{% endblock %}